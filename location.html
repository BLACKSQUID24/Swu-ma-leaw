<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asthma Buddy - Search Pharmacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>@import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap'); body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-50 pb-24">
    <header class="bg-orange-500 text-white p-4 text-center sticky top-0 z-50 shadow-md">
        <h1 class="text-xl font-medium">ค้นหาร้านยาและคลังยา</h1>
    </header>

    <main class="p-4 max-w-md mx-auto">
        <div class="mb-4 space-y-2">
            <div class="relative">
                <input type="text" id="manual-search" placeholder="พิมพ์ชื่อร้าน หรือ ชื่อเขต (เช่น มีนบุรี)..." 
                    class="w-full p-4 pl-12 rounded-2xl border-none shadow-md focus:ring-2 focus:ring-orange-400 outline-none text-sm">
                <i class="fa-solid fa-store absolute left-4 top-4.5 text-orange-500 text-lg"></i>
            </div>
            <button onclick="searchByName()" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">
                <i class="fa-solid fa-magnifying-glass mr-2"></i> ค้นหาตอนนี้
            </button>
        </div>

        <div class="flex items-center my-6">
            <div class="flex-grow border-t border-gray-300"></div>
            <span class="px-3 text-gray-400 text-xs uppercase italic">หรือ</span>
            <div class="flex-grow border-t border-gray-300"></div>
        </div>

        <button onclick="getLocationAndSearch()" class="w-full bg-white border-2 border-orange-500 text-orange-600 py-3 rounded-xl font-bold mb-6 active:scale-95 transition">
            <i class="fa-solid fa-location-crosshairs mr-2"></i> ค้นหาจากตำแหน่งใกล้ตัว
        </button>

        <div id="status-text" class="text-center text-sm text-gray-500 mb-4 hidden"></div>
        <div id="list" class="space-y-3">
            </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around p-3 shadow-lg z-50">
        <a href="index.html" class="flex flex-col items-center text-gray-400"><i class="fa-solid fa-chart-line text-xl"></i><span class="text-[10px] mt-1">Dashboard</span></a>
        <a href="location.html" class="flex flex-col items-center text-orange-500"><i class="fa-solid fa-location-dot text-xl"></i><span class="text-[10px] mt-1">Location</span></a>
    </nav>

    <script>
        // ฟังก์ชัน 1: ค้นหาด้วยชื่อที่พิมพ์
        async function searchByName() {
            const keyword = document.getElementById('manual-search').value;
            if (!keyword) return alert("กรุณาพิมพ์ชื่อร้านหรือชื่อเขต");

            showLoading(true);
            // Query ค้นหาจากชื่อร้านยาในประเทศไทย
            const query = `[out:json];node["amenity"="pharmacy"]["name"~"${keyword}"](12.0,99.0,15.0,102.0);out;`;
            fetchAndRender(query);
        }

        // ฟังก์ชัน 2: ค้นหาจากพิกัด (เหมือนเดิม)
        function getLocationAndSearch() {
            showLoading(true);
            navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                const query = `[out:json];(node["amenity"="pharmacy"](around:5000,${lat},${lon});node["shop"="drugstore"](around:5000,${lat},${lon}););out;`;
                fetchAndRender(query);
            });
        }

        async function fetchAndRender(query) {
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const shops = data.elements;
                
                if (shops.length === 0) {
                    document.getElementById('list').innerHTML = `<p class="text-center text-gray-400 my-10">ไม่พบข้อมูลที่ระบุ ลองเปลี่ยนคำค้นหา</p>`;
                } else {
                    renderList(shops);
                }
            } catch (e) {
                alert("การเชื่อมต่อขัดข้อง");
            } finally {
                showLoading(false);
            }
        }

        function renderList(shops) {
            document.getElementById('list').innerHTML = shops.map(s => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 ${s.tags.shop ? 'border-blue-500' : 'border-green-500'} flex justify-between items-center">
                    <div class="flex-1 pr-2">
                        <h4 class="font-bold text-gray-800 text-sm">${s.tags.name || 'ร้านยา/เภสัช'}</h4>
                        <p class="text-[10px] text-gray-500 mt-1 uppercase tracking-tighter">${s.tags.shop ? 'คลังยา' : 'ร้านยา/เภสัช'}</p>
                    </div>
                    <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lon}')" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md">นำทาง</button>
                </div>
            `).join('');
        }

        function showLoading(status) {
            document.getElementById('status-text').classList.toggle('hidden', !status);
            document.getElementById('status-text').innerText = status ? "กำลังค้นหาข้อมูล..." : "";
        }
    </script>
</body>
</html>